# СИСТЕМА WASHINGTON - ПОЛНОЕ ОПИСАНИЕ ЛОГИКИ

## ОБЩЕЕ ОПИСАНИЕ

Система Washington представляет собой комплексную платформу для управления государственными процессами, судебными делами, правоохранительной деятельностью и административными функциями в игровом мире. Система построена на современном стеке технологий с использованием Next.js, TypeScript, Supabase и Tailwind CSS.

## АРХИТЕКТУРА СИСТЕМЫ

### Фронтенд
- **Next.js 14** - React фреймворк с App Router
- **TypeScript** - типизированный JavaScript
- **Tailwind CSS** - утилитарный CSS фреймворк
- **Supabase Client** - клиент для работы с базой данных

### Бэкенд
- **Supabase** - Backend-as-a-Service платформа
- **PostgreSQL** - реляционная база данных
- **Row Level Security (RLS)** - безопасность на уровне строк
- **Real-time subscriptions** - обновления в реальном времени

## ОСНОВНЫЕ МОДУЛИ СИСТЕМЫ

**Новинка**: Добавлена полнофункциональная страница штрафов с возможностью создания, просмотра и управления статусами.

### 1. СИСТЕМА АУТЕНТИФИКАЦИИ И ПРОФИЛЕЙ

#### Профили пользователей (`profiles`)
- **Основные поля**: id, email, nickname, discord, full_name, static_id
- **Роли**: faction, gov_role, leader_role, office_role
- **Статус**: is_verified (верификация аккаунта)
- **Автоматическое создание**: профиль создается автоматически при регистрации

#### Система ролей
- **Фракции**: CIVILIAN, GOV, COURT, WN, FIB, LSPD, LSCSD, EMS, SANG
- **Государственные роли**: NONE, PROSECUTOR, JUDGE, TECH_ADMIN, ATTORNEY_GENERAL, CHIEF_JUSTICE
- **Лидерские роли**: GOVERNOR, DIRECTOR_WN, DIRECTOR_FIB, CHIEF_LSPD, SHERIFF_LSCSD, CHIEF_EMS, COLONEL_SANG
- **Офисные роли**: GOVERNOR, VICE_GOVERNOR, MIN_FINANCE, MIN_JUSTICE, BAR_ASSOCIATION, GOV_STAFF, MIN_DEFENSE, MIN_SECURITY, MIN_HEALTH, OTHER

### 2. СИСТЕМА НАЗНАЧЕНИЙ И ВЕРИФИКАЦИИ

#### Назначения (`appointments`)
- **Назначение на должности** в различных департаментах
- **Статусы**: PENDING, APPROVED, REJECTED, DONE, CANCELLED
- **Процесс**: пользователь создает запрос → администратор рассматривает → решение
- **Доступность**: любой залогиненный пользователь может записаться на прием
- **Демократичность**: равные возможности для всех пользователей

#### Запросы на верификацию (`verification_requests`)
- **Типы**: FACTION_MEMBER, PROSECUTOR, JUDGE
- **Процесс**: пользователь запрашивает роль → администратор проверяет → решение
- **Автоматическое обновление**: при одобрении профиль автоматически обновляется

### 3. СИСТЕМА ЗАПРОСОВ НА ИЗМЕНЕНИЕ РОЛЕЙ

#### Запросы на изменение ролей (`role_change_requests`)
- **Типы запросов**: FACTION, GOV_ROLE, LEADER_ROLE, OFFICE_ROLE
- **Статусы**: PENDING, APPROVED, REJECTED
- **Процесс**: пользователь запрашивает изменение → администратор рассматривает → решение
- **Отслеживание**: кто создал, кто рассмотрел, комментарии, время

### 4. СИСТЕМА ГОСУДАРСТВЕННЫХ И СУДЕБНЫХ АКТОВ

#### Государственные акты (`gov_acts`)
- **Содержание**: номер акта, заголовок, описание, полный текст
- **Публикация**: published (опубликован/черновик)
- **Источники**: source_url для ссылок на оригиналы
- **Права доступа**: TECH_ADMIN, ATTORNEY_GENERAL, PROSECUTOR
- **Интерактивность**: все акты кликабельны и открываются в новой странице
- **Хранение**: полное содержание хранится в базе данных

#### Судебные акты (`court_acts`)
- **Аналогично государственным актам**
- **Специфика**: судебные решения, приговоры, постановления
- **Права доступа**: TECH_ADMIN, CHIEF_JUSTICE, JUDGE
- **Интерактивность**: все акты кликабельны и открываются в новой странице
- **Хранение**: полное содержание хранится в базе данных

### 5. СИСТЕМА ОРДЕРОВ И ПРАВООХРАНИТЕЛЬНОЙ ДЕЯТЕЛЬНОСТИ

#### Ордера (`warrants`)
- **Типы**: AS (Arrest & Search), S (Search), A (Arrest)
- **Статусы**: active, executed, expired, cancelled
- **Содержание**: номер ордера, цель, причина, статьи закона, срок действия
- **Права доступа**: TECH_ADMIN, ATTORNEY_GENERAL, CHIEF_JUSTICE, PROSECUTOR, JUDGE
- **Интерактивность**: все ордера кликабельны и открываются в новой странице

#### Дела (`cases`)
- **Судебные дела** с полным жизненным циклом
- **Назначение**: assigned_to для распределения нагрузки
- **События**: case_events для отслеживания прогресса
- **Права доступа**: TECH_ADMIN, ATTORNEY_GENERAL, CHIEF_JUSTICE, PROSECUTOR, JUDGE
- **Интерактивность**: все дела кликабельны и открываются в новой странице

#### Судебные сессии (`court_sessions`)
- **Планирование судебных заседаний**
- **Статусы**: планируется, в процессе, завершена
- **Участники**: судьи, прокуроры, адвокаты

### 6. СИСТЕМА АДВОКАТУРЫ

#### Адвокаты (`lawyers`)
- **Лицензии**: номер лицензии, специализация
- **Статусы**: ACTIVE, SUSPENDED, REVOKED
- **Профили**: связь с пользователями системы

#### Адвокатские контракты (`lawyer_contracts`)
- **Связь**: адвокат ↔ клиент ↔ дело
- **Статусы**: ACTIVE, COMPLETED, CANCELLED
- **Отслеживание**: время создания, обновления

#### Запросы адвокатов (`lawyer_requests`)
- **Создание**: любой залогиненный пользователь
- **Типы**: LICENSES, SPECIALIZATION, STATUS_CHANGE
- **Статусы**: PENDING, APPROVED, REJECTED
- **Доступность**: демократичный доступ для всех пользователей

### 7. СИСТЕМА ИНСПЕКЦИЙ И ШТРАФОВ

**Примечание**: Страницы государственных структур (EMS, LSPD, LSCSD, SANG, FIB, WN) удалены из системы.

#### Инспекции (`inspections`)
- **Проверки** различных объектов и организаций
- **Статусы**: PENDING, IN_PROGRESS, COMPLETED, CANCELLED
- **Права доступа**: ATTORNEY_GENERAL, CHIEF_EMS, GOVERNOR, MIN_HEALTH
- **Специфика**: медицинские и санитарные проверки

#### Штрафы (`fines`)
- **Взыскания** за нарушения
- **Статусы**: UNPAID, PAID, CANCELLED
- **Выдающие**: TECH_ADMIN, ATTORNEY_GENERAL, CHIEF_JUSTICE, PROSECUTOR, JUDGE
- **Отслеживание**: время выдачи, оплаты
- **Управление**: изменение статуса на "оплачен" или "отменен"
- **Автоматическое обновление**: время оплаты при смене статуса

## БЕЗОПАСНОСТЬ И ПРАВА ДОСТУПА

### Row Level Security (RLS)
- **Включен для всех таблиц**
- **Политики доступа** на основе ролей пользователей
- **Автоматическая проверка** прав при каждом запросе

### Уровни доступа
1. **Публичный доступ**: просмотр большинства данных
2. **Пользовательский**: создание и редактирование собственных записей
3. **Ролевой**: доступ на основе фракции или государственной роли
4. **Административный**: полный доступ для TECH_ADMIN, ATTORNEY_GENERAL, CHIEF_JUSTICE

### Детальные права доступа по модулям:

#### Ордера (warrants)
- **Создание**: TECH_ADMIN, ATTORNEY_GENERAL, CHIEF_JUSTICE, PROSECUTOR, JUDGE
- **Просмотр**: все пользователи
- **Редактирование**: создатель или TECH_ADMIN

#### Судебные акты (court_acts)
- **Создание**: TECH_ADMIN, CHIEF_JUSTICE, JUDGE
- **Просмотр**: все пользователи
- **Редактирование**: создатель

#### Акты правительства (gov_acts)
- **Создание**: TECH_ADMIN, ATTORNEY_GENERAL, PROSECUTOR
- **Просмотр**: все пользователи
- **Редактирование**: создатель

#### Дела (cases)
- **Создание**: TECH_ADMIN, ATTORNEY_GENERAL, CHIEF_JUSTICE, PROSECUTOR, JUDGE
- **Просмотр**: все пользователи
- **Редактирование**: создатель

#### Штрафы (fines)
- **Создание**: TECH_ADMIN, ATTORNEY_GENERAL, CHIEF_JUSTICE, PROSECUTOR, JUDGE
- **Просмотр**: все пользователи
- **Редактирование**: создатель или TECH_ADMIN

#### Инспекции (inspections)
- **Создание**: ATTORNEY_GENERAL, CHIEF_EMS, GOVERNOR, MIN_HEALTH
- **Просмотр**: все пользователи

#### Запросы адвокатов (lawyer_requests)
- **Создание**: любой залогиненный пользователь
- **Просмотр**: все пользователи
- **Редактирование**: создатель

#### Назначения (appointments)
- **Создание**: любой залогиненный пользователь
- **Просмотр**: все пользователи
- **Редактирование**: создатель или администраторы

### Примеры политик безопасности
```sql
-- Пользователи могут просматривать все ордера
CREATE POLICY "Users can view warrants" ON warrants FOR SELECT USING (true);

-- Создавать ордера могут только тех. админы, прокуроры, ген. прок, судьи, ПВС
CREATE POLICY "Authorized users can create warrants" ON warrants FOR INSERT WITH CHECK (
    EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND 
           gov_role IN ('TECH_ADMIN', 'ATTORNEY_GENERAL', 'CHIEF_JUSTICE', 'PROSECUTOR', 'JUDGE'))
);

-- Создавать штрафы могут только тех. админы, прокуроры, ген. прок, судьи, ПВС
CREATE POLICY "Authorized users can create fines" ON fines FOR INSERT WITH CHECK (
    EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND 
           gov_role IN ('TECH_ADMIN', 'ATTORNEY_GENERAL', 'CHIEF_JUSTICE', 'PROSECUTOR', 'JUDGE'))
);

-- Создавать инспекции могут только лидер EMS, Минздрав, Ген. прок, Губернатор
CREATE POLICY "Authorized users can create inspections" ON inspections FOR INSERT WITH CHECK (
    EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND 
           (gov_role IN ('ATTORNEY_GENERAL') OR 
            leader_role IN ('CHIEF_EMS', 'GOVERNOR') OR
            office_role IN ('MIN_HEALTH')))
);
```

## АВТОМАТИЗАЦИЯ И ТРИГГЕРЫ

### Автоматическое создание профилей
```sql
CREATE OR REPLACE FUNCTION handle_new_user()
RETURNS TRIGGER AS $$
DECLARE
    user_nickname TEXT;
    user_static_id TEXT;
    user_discord TEXT;
    user_faction TEXT;
BEGIN
    -- Извлекаем данные из метаданных с проверками
    user_nickname := COALESCE(NEW.raw_user_meta_data->>'nickname', 'User');
    user_static_id := COALESCE(NEW.raw_user_meta_data->>'static_id', 'user_' || substr(NEW.id::text, 1, 8));
    user_discord := NEW.raw_user_meta_data->>'discord';
    user_faction := COALESCE(NEW.raw_user_meta_data->>'faction', 'CIVILIAN');
    
    -- Создаем профиль с полной информацией
    INSERT INTO public.profiles (
        id, nickname, static_id, email, discord, faction, gov_role, is_verified, created_at, updated_at
    ) VALUES (
        NEW.id, user_nickname, user_static_id, NEW.email, user_discord, user_faction, 'NONE', false, NOW(), NOW()
    );
    
    RETURN NEW;
EXCEPTION
    WHEN OTHERS THEN
        -- Записываем ошибку в лог, но не прерываем регистрацию
        RAISE LOG 'Error in handle_new_user for user %: %', NEW.id, SQLERRM;
        RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### Автоматическое обновление времени
```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';
```

## ОПТИМИЗАЦИЯ ПРОИЗВОДИТЕЛЬНОСТИ

### Индексы
- **Первичные ключи**: автоматические индексы
- **Внешние ключи**: индексы для быстрых JOIN
- **Часто используемые поля**: email, nickname, faction, gov_role
- **Статусы**: для быстрой фильтрации

### Примеры индексов
```sql
CREATE INDEX idx_profiles_email ON profiles(email);
CREATE INDEX idx_profiles_faction ON profiles(faction);
CREATE INDEX idx_warrants_status ON warrants(status);
CREATE INDEX idx_cases_created_by ON cases(created_by);
```

## ИНТЕГРАЦИЯ С FRONTEND

### Типы данных
- **Полная типизация** всех сущностей
- **Экспорт типов** из supabase/client.ts
- **Автоматическая проверка** типов в TypeScript

### Пример использования типов
```typescript
import type { Profile, Warrant, WarrantType } from "../../lib/supabase/client";

const [warrants, setWarrants] = useState<Warrant[]>([]);
const [user, setUser] = useState<Profile | null>(null);
```

### Supabase клиент
- **Централизованный клиент** для всех запросов
- **Типизированные запросы** к базе данных
- **Обработка ошибок** и состояний загрузки

## ЖИЗНЕННЫЕ ЦИКЛЫ ОСНОВНЫХ СУЩНОСТЕЙ

### 1. Регистрация пользователя
1. Пользователь регистрируется в Supabase Auth
2. Автоматически создается профиль в таблице profiles с полной информацией
3. Пользователь заполняет дополнительную информацию
4. Возможность подачи заявок на роли и верификацию
5. **Новые возможности**: запись на прием, создание запросов адвоката для всех пользователей

### 2. Процесс назначения на должность
1. Пользователь создает запрос на назначение
2. Администратор рассматривает заявку
3. При одобрении статус меняется на APPROVED
4. При отклонении статус REJECTED с комментарием

### 2.1. Процесс создания актов
1. Авторизованный пользователь создает акт (правительства или судебный)
2. Заполняет все обязательные поля (номер, заголовок, содержание)
3. Акт сохраняется в базе данных с полным текстом
4. Все акты кликабельны и открываются в новой странице для детального просмотра
5. Возможность публикации или сохранения как черновик

### 3. Процесс создания ордера
1. Авторизованный пользователь создает ордер
2. Заполняет все обязательные поля
3. Устанавливает срок действия
4. Ордер получает статус active
5. При исполнении статус меняется на executed
6. Все ордера кликабельны и открываются в новой странице для детального просмотра

### 4. Процесс судебного дела
1. Создание дела с базовой информацией
2. Назначение ответственного лица
3. Добавление событий по делу
4. Планирование судебных сессий
5. Завершение дела

### 5. Процесс создания штрафа
1. Авторизованный пользователь создает штраф
2. Заполняет все обязательные поля (нарушитель, сумма, причина)
3. Штраф получает статус UNPAID
4. При оплате статус меняется на PAID с автоматическим обновлением времени
5. Возможность отмены штрафа администратором

## МОНИТОРИНГ И ЛОГИРОВАНИЕ

### Аудит изменений
- **Время создания** и обновления всех записей
- **Автор изменений** через created_by, updated_by
- **История изменений** через updated_at

### Отслеживание статусов
- **Изменения статусов** всех сущностей
- **Время изменений** для анализа производительности
- **Авторы изменений** для ответственности

## РАСШИРЯЕМОСТЬ СИСТЕМЫ

**Важное изменение**: Страницы государственных структур (EMS, LSPD, LSCSD, SANG, FIB, WN) удалены из системы для упрощения архитектуры и сосредоточения на основных функциях.

### Добавление новых модулей
1. **Создание таблицы** с необходимыми полями
2. **Определение типов** в TypeScript
3. **Настройка RLS** политик
4. **Создание индексов** для оптимизации
5. **Добавление триггеров** для автоматизации

### Пример добавления нового модуля
```sql
-- Новая таблица
CREATE TABLE new_module (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name TEXT NOT NULL,
    created_by UUID REFERENCES profiles(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- RLS политики
ALTER TABLE new_module ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view new module" ON new_module FOR SELECT USING (true);

-- Индексы
CREATE INDEX idx_new_module_created_by ON new_module(created_by);
```

## ЗАКЛЮЧЕНИЕ

Система Washington представляет собой комплексное решение для управления государственными процессами с акцентом на безопасность, производительность и удобство использования. Архитектура системы позволяет легко расширять функциональность и адаптировать под новые требования.

### Ключевые преимущества
- **Безопасность**: RLS политики, проверка прав доступа
- **Производительность**: оптимизированные индексы, эффективные запросы
- **Масштабируемость**: модульная архитектура, легкость расширения
- **Типизация**: полная типизация на всех уровнях
- **Автоматизация**: триггеры, функции, автоматические обновления
- **Демократичность**: равный доступ к базовым функциям для всех пользователей
- **Интерактивность**: все акты, ордера и дела кликабельны
- **Новые модули**: полнофункциональная страница штрафов с управлением статусами
