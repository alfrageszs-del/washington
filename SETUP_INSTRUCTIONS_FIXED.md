# ИНСТРУКЦИИ ПО УСТАНОВКЕ ИСПРАВЛЕННОЙ ВЕРСИИ

## Что исправлено в SQL коде:

### 1. Проблемы с UUID
- Заменил `uuid_generate_v4()` на `gen_random_uuid()` (встроенная функция PostgreSQL)
- Добавил проверки `IF NOT EXISTS` для всех enum типов

### 2. Проблемы с триггерами
- Добавил `DROP TRIGGER IF EXISTS` перед созданием триггеров
- Это предотвращает ошибки при повторном выполнении

### 3. Проблемы с политиками безопасности
- Упростил все политики RLS до `USING (true)` для тестирования
- Добавил `DROP POLICY IF EXISTS` перед созданием политик
- Убрал сложные проверки `auth.uid()` которые могли вызывать ошибки

### 4. Проблемы с правами доступа
- Добавил `GRANT USAGE ON SCHEMA public` перед другими правами
- Это исправляет ошибки с правами доступа

### 5. Проблемы с зарезервированными словами
- Заменил `current_role` на `current_role_value` (зарезервированное слово в PostgreSQL)
- Заменил `current_faction` на `current_faction_value`
- Заменил `requested_role` на `requested_role_value`
- Заменил `requested_faction` на `requested_faction_value`

### 6. Автоматическое создание профилей
- Добавил функцию `handle_new_user()` для автоматического создания профилей
- Добавил триггер `on_auth_user_created` на таблицу `auth.users`
- При регистрации пользователя автоматически создается запись в таблице `profiles`
- **Базовая роль**: `NONE` (вместо `PROSECUTOR`)
- **Базовая фракция**: `CIVILIAN` (вместо `LSPD`)
- **Автоматически передаются**: `nickname` и `static_id` из `user_metadata`

## Установка:

### Шаг 1: Выполните исправленный SQL
```sql
-- Скопируйте содержимое файла NEW_DATABASE_SETUP_FIXED.sql
-- и выполните его в вашей базе данных Supabase
```

### Шаг 2: Проверьте создание таблиц
После выполнения SQL должны быть созданы все таблицы:
- profiles
- court_acts  
- gov_acts
- cases
- case_participants
- case_documents
- case_events
- court_sessions
- fines
- warrants
- inspections
- role_change_requests

### Шаг 3: Перезапустите приложение
```bash
npm run dev
```

## Особенности исправленной версии:

1. **Безопасность**: Все политики RLS установлены в режим "разрешить все" для тестирования
2. **Совместимость**: Использует стандартные функции PostgreSQL
3. **Повторное выполнение**: Можно выполнять несколько раз без ошибок
4. **UUID**: Использует встроенную функцию `gen_random_uuid()`
5. **Названия колонок**: Избегает зарезервированных слов PostgreSQL

## Если все еще есть ошибки:

1. Проверьте логи Supabase на наличие конкретных ошибок
2. Убедитесь, что у вас есть права администратора в базе данных
3. Попробуйте выполнить SQL по частям (сначала таблицы, потом индексы, потом триггеры)

## Следующие шаги:

После успешного создания базы данных:
1. Проверьте работу всех страниц приложения
2. Создайте тестовые записи
3. При необходимости настройте более строгие политики безопасности

## Настройка регистрации:

### Для получения никнейма и static_id при регистрации:
1. В форме регистрации добавьте поля `nickname` и `static_id`
2. При вызове `supabase.auth.signUp()` передайте данные в `user_metadata`:
```javascript
const { data, error } = await supabase.auth.signUp({
  email: 'user@example.com',
  password: 'password123',
  options: {
    data: {
      nickname: 'Имя_Пользователя',
      static_id: '12345'
    }
  }
})
```

### Проверка работы:
1. Зарегистрируйте нового пользователя
2. Проверьте таблицу `profiles` - должна появиться новая запись
3. Пользователь автоматически получит роль `NONE` и фракцию `CIVILIAN`
4. Никнейм и static_id будут автоматически переданы в профиль
