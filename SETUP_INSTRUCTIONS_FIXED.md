# Инструкции по настройке системы - ИСПРАВЛЕННАЯ ВЕРСИЯ

## Шаг 1: Настройка базы данных

1. **Создайте новую базу данных в Supabase** (если еще не создали)
2. **Выполните основной SQL скрипт**: `NEW_DATABASE_SETUP_FIXED.sql`
3. **Если возникает ошибка регистрации**, выполните дополнительный скрипт: `FIX_REGISTRATION_ERROR.sql`

## Шаг 2: Настройка переменных окружения

Создайте файл `.env.local` в корне проекта:

```env
NEXT_PUBLIC_SUPABASE_URL=ваш_url_supabase
NEXT_PUBLIC_SUPABASE_ANON_KEY=ваш_anon_key
```

## Шаг 3: Регистрация пользователей

При регистрации пользователя через `supabase.auth.signUp()` передавайте `nickname` и `static_id` в `user_metadata`:

```typescript
const { data, error } = await supabase.auth.signUp({
  email: 'user@example.com',
  password: 'password123',
  options: {
    data: {
      nickname: 'ИмяПользователя',
      static_id: 'ID001'
    }
  }
});
```

## Шаг 4: Автоматическое создание профилей

Система автоматически создает профили для новых пользователей со следующими настройками:
- **Роль по умолчанию**: `NONE`
- **Фракция по умолчанию**: `CIVILIAN`
- **Никнейм**: берется из `user_metadata.nickname` или "Новый пользователь"
- **Static ID**: берется из `user_metadata.static_id` или "N/A"

## Шаг 5: Проверка работы

1. Зарегистрируйте нового пользователя
2. Проверьте, что профиль создался в таблице `profiles`
3. Проверьте, что все функции работают корректно

## Важные замечания

- **НЕ изменяйте базу данных** после выполнения SQL скриптов
- Все исправления делаются только в коде фронтенда
- Если возникают ошибки, проверьте консоль браузера и логи Supabase

## Устранение неполадок

### Ошибка "Database error saving new user"
Выполните скрипт `FIX_REGISTRATION_ERROR.sql` в вашей базе данных.

### Пользователь не появляется в профилях
Проверьте, что триггер `on_auth_user_created` создан и работает корректно.

### Ошибки с колонками
Убедитесь, что все таблицы созданы с правильной структурой согласно `NEW_DATABASE_SETUP_FIXED.sql`.
