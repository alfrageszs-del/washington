# Исправления проблем в базе данных WASHINGTON (Версия 2)

## Описание

Файл `fix_database_issues_v2.sql` содержит исправления для всех найденных проблем в существующей базе данных, включая новые проблемы, обнаруженные после первого исправления.

## Проблемы, которые исправляются

### 1. Проблема с регистрацией пользователей
- **Симптом**: После регистрации аккаунт сохраняется в `auth.users`, но не переходит в таблицу `profiles`
- **Причина**: Функция `handle_new_user()` не была правильно настроена
- **Решение**: Пересоздание функции с правильной логикой извлечения данных из метаданных

### 2. Ошибка в актах правительства
- **Симптом**: `Ошибка загрузки актов: column gov_acts.status does not exist`
- **Причина**: Отсутствует колонка `status` в таблице `gov_acts`
- **Решение**: Добавление колонки `status` с проверкой значений

### 3. Ошибка в судебных актах
- **Симптом**: `Ошибка загрузки актов: column court_acts.status does not exist`
- **Причина**: Отсутствует колонка `status` в таблице `court_acts`
- **Решение**: Добавление колонки `status` с проверкой значений

### 4. Ошибка в штрафах
- **Симптом**: `Ошибка загрузки штрафов: column fines.created_at does not exist`
- **Причина**: Отсутствует колонка `created_at` в таблице `fines`
- **Решение**: Добавление колонки `created_at` с временной меткой

### 5. Ошибка в запросах на смену роли
- **Симптом**: `Could not find the 'current_faction_value' column of 'role_change_requests' in the schema cache`
- **Причина**: Отсутствует колонка `current_faction_value` в таблице `role_change_requests`
- **Решение**: Добавление колонки `current_faction_value`

### 6. НОВАЯ ПРОБЛЕМА: Ошибка в запросах на смену роли (роль)
- **Симптом**: `Could not find the 'current_role_value' column of 'role_change_requests' in the schema cache`
- **Причина**: Отсутствует колонка `current_role_value` в таблице `role_change_requests`
- **Решение**: Добавление колонки `current_role_value`

### 7. НОВАЯ ПРОБЛЕМА: Ошибка в делах
- **Симптом**: `Could not find a relationship between 'cases' and 'profiles' in the schema cache`
- **Причина**: Отсутствуют колонки для связей с профилями (`prosecutor_id`, `judge_id`)
- **Решение**: Добавление колонок `prosecutor_id` и `judge_id` с внешними ключами

### 8. НОВАЯ ПРОБЛЕМА: Ошибка в проверках и надзоре
- **Симптом**: `Could not find a relationship between 'inspections' and 'profiles' in the schema cache`
- **Причина**: Отсутствует колонка `inspector_id` для связи с профилями
- **Решение**: Добавление колонки `inspector_id` с внешним ключом

### 9. НОВАЯ ПРОБЛЕМА: Проблемы с адвокатами
- **Симптом**: Адвокаты не запрашиваются, выдается ошибка без конкретики
- **Причина**: Отсутствуют необходимые колонки в таблице `lawyers`
- **Решение**: Добавление колонок `status`, `created_at`, `updated_at`

### 10. НОВАЯ ПРОБЛЕМА: Заголовок страницы "Дела"
- **Симптом**: На странице "Дела" отображается "Судебные дела" вместо "Дела"
- **Причина**: Неправильный заголовок в коде приложения
- **Решение**: Изменение заголовка с "Судебные дела" на "Дела"

## Порядок применения

### Шаг 1: Применение основного SQL
```bash
# Сначала примените основной файл схемы
psql -d your_database -f database_schema.sql
```

### Шаг 2: Применение исправлений версии 2
```bash
# Затем примените исправления версии 2
psql -d your_database -f fix_database_issues_v2.sql
```

## Что делает файл исправлений версии 2

1. **Пересоздает функцию `handle_new_user()`**
   - Правильно извлекает `nickname`, `static_id`, `discord`, `faction` из метаданных
   - Создает профиль с полной информацией
   - Обрабатывает ошибки без прерывания регистрации

2. **Добавляет недостающие колонки**
   - `gov_acts.status` - статус акта правительства
   - `court_acts.status` - статус судебного акта
   - `fines.created_at` - время создания штрафа
   - `role_change_requests.current_faction_value` - текущее значение фракции
   - `role_change_requests.current_role_value` - текущее значение роли

3. **Исправляет связи между таблицами**
   - `cases.prosecutor_id` - связь с прокурором
   - `cases.judge_id` - связь с судьей
   - `inspections.inspector_id` - связь с инспектором
   - Переименование `assigned_to` в `judge_id` для совместимости

4. **Дополняет таблицу lawyers**
   - `status` - статус адвоката
   - `created_at` - время создания
   - `updated_at` - время обновления

5. **Создает необходимые индексы**
   - Для новых колонок `status` и `created_at`
   - Для новых связей между таблицами

6. **Обновляет RLS политики**
   - Приводит политики в соответствие с новой структурой таблиц
   - Учитывает новые связи между таблицами

7. **Проверяет результат**
   - Выводит статус всех исправлений
   - Подтверждает создание функций и триггеров
   - Проверяет наличие всех необходимых колонок

## Безопасность

- Файл использует `DO $$` блоки для безопасного добавления колонок
- Все операции проверяют существование объектов перед выполнением
- Используется `DROP ... IF EXISTS` для безопасного удаления
- Функция `handle_new_user()` имеет обработку ошибок
- Переименование колонок происходит только при необходимости

## Проверка результата

После выполнения файла вы увидите:
- Статус всех добавленных колонок
- Подтверждение создания функции `handle_new_user`
- Подтверждение создания триггера `on_auth_user_created`
- Статус всех связей между таблицами
- Сообщение об успешном завершении

## Требования

- PostgreSQL 9.2 или выше (для `DROP ... IF EXISTS`)
- Права на создание функций и триггеров
- Существующая база данных с таблицами из `database_schema.sql`

## Примечания

- Файл можно запускать многократно без вреда
- Все операции идемпотентны (безопасны при повторном выполнении)
- Проверки существования предотвращают ошибки дублирования
- Переименование колонок происходит только при отсутствии целевой колонки
- Все внешние ключи правильно настроены для связей между таблицами

## Изменения в коде приложения

- Заголовок страницы "Дела" изменен с "Судебные дела" на "Дела"
- Комментарий в SQL схеме обновлен для соответствия
