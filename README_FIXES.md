# Исправления проблем в базе данных WASHINGTON

## Описание

Файл `fix_database_issues.sql` содержит исправления для всех найденных проблем в существующей базе данных.

## Проблемы, которые исправляются

### 1. Проблема с регистрацией пользователей
- **Симптом**: После регистрации аккаунт сохраняется в `auth.users`, но не переходит в таблицу `profiles`
- **Причина**: Функция `handle_new_user()` не была правильно настроена
- **Решение**: Пересоздание функции с правильной логикой извлечения данных из метаданных

### 2. Ошибка в актах правительства
- **Симптом**: `Ошибка загрузки актов: column gov_acts.status does not exist`
- **Причина**: Отсутствует колонка `status` в таблице `gov_acts`
- **Решение**: Добавление колонки `status` с проверкой значений

### 3. Ошибка в судебных актах
- **Симптом**: `Ошибка загрузки актов: column court_acts.status does not exist`
- **Причина**: Отсутствует колонка `status` в таблице `court_acts`
- **Решение**: Добавление колонки `status` с проверкой значений

### 4. Ошибка в штрафах
- **Симптом**: `Ошибка загрузки штрафов: column fines.created_at does not exist`
- **Причина**: Отсутствует колонка `created_at` в таблице `fines`
- **Решение**: Добавление колонки `created_at` с временной меткой

### 5. Ошибка в запросах на смену роли
- **Симптом**: `Could not find the 'current_faction_value' column of 'role_change_requests' in the schema cache`
- **Причина**: Отсутствует колонка `current_faction_value` в таблице `role_change_requests`
- **Решение**: Добавление колонки `current_faction_value`

## Порядок применения

### Шаг 1: Применение основного SQL
```bash
# Сначала примените основной файл схемы
psql -d your_database -f database_schema.sql
```

### Шаг 2: Применение исправлений
```bash
# Затем примените исправления
psql -d your_database -f fix_database_issues.sql
```

## Что делает файл исправлений

1. **Пересоздает функцию `handle_new_user()`**
   - Правильно извлекает `nickname`, `static_id`, `discord`, `faction` из метаданных
   - Создает профиль с полной информацией
   - Обрабатывает ошибки без прерывания регистрации

2. **Добавляет недостающие колонки**
   - `gov_acts.status` - статус акта правительства
   - `court_acts.status` - статус судебного акта
   - `fines.created_at` - время создания штрафа
   - `role_change_requests.current_faction_value` - текущее значение фракции

3. **Создает необходимые индексы**
   - Для новых колонок `status` и `created_at`

4. **Обновляет RLS политики**
   - Приводит политики в соответствие с новой структурой таблиц

5. **Проверяет результат**
   - Выводит статус всех исправлений
   - Подтверждает создание функций и триггеров

## Безопасность

- Файл использует `DO $$` блоки для безопасного добавления колонок
- Все операции проверяют существование объектов перед выполнением
- Используется `DROP ... IF EXISTS` для безопасного удаления
- Функция `handle_new_user()` имеет обработку ошибок

## Проверка результата

После выполнения файла вы увидите:
- Статус всех добавленных колонок
- Подтверждение создания функции `handle_new_user`
- Подтверждение создания триггера `on_auth_user_created`
- Сообщение об успешном завершении

## Требования

- PostgreSQL 9.2 или выше (для `DROP ... IF EXISTS`)
- Права на создание функций и триггеров
- Существующая база данных с таблицами из `database_schema.sql`

## Примечания

- Файл можно запускать многократно без вреда
- Все операции идемпотентны (безопасны при повторном выполнении)
- Проверки существования предотвращают ошибки дублирования
