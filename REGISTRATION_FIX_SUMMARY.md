# Исправление ошибки регистрации пользователей

## Проблема
При регистрации нового пользователя возникала ошибка "Database error saving new user".

## Причина
Функция `handle_new_user()` в триггере `on_auth_user_created` имела несколько проблем:
1. Не указывала обязательное поле `email` при вставке в таблицу `profiles`
2. Использовала `SECURITY DEFINER` вместо `SECURITY INVOKER`
3. Не имела правильных прав доступа

## Решение
1. **Исправлен SQL скрипт** `NEW_DATABASE_SETUP_FIXED.sql`:
   - Добавлено поле `email` в INSERT
   - Изменен `SECURITY DEFINER` на `SECURITY INVOKER`
   - Добавлены права на выполнение функции

2. **Создан дополнительный скрипт** `FIX_REGISTRATION_ERROR.sql` для быстрого исправления

## Что исправлено
- ✅ Функция `handle_new_user()` теперь корректно вставляет все обязательные поля
- ✅ Триггер `on_auth_user_created` работает с правильными правами доступа
- ✅ Новые пользователи автоматически получают профили с ролью `NONE` и фракцией `CIVILIAN`
- ✅ Никнейм и static_id корректно передаются из `user_metadata`

## Как применить исправление
1. Выполните скрипт `FIX_REGISTRATION_ERROR.sql` в вашей базе данных
2. Или пересоздайте базу данных с исправленным `NEW_DATABASE_SETUP_FIXED.sql`

## Результат
После исправления регистрация пользователей должна работать корректно, и профили будут создаваться автоматически.
